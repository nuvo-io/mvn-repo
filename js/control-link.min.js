(function(){var e,j,m,n,d,c,l,h,f,b,a,i,k,g;importScripts("vortex-web-client.min.js");k=this;g=coffez;a=dds.runtime;f=true;l=function(q,o,p){return{cid:q,ek:o,sn:p}};h=function(o){return{did:o.did,tn:o.tname,tt:o.ttype,trt:o.tregtype,qos:o.qos.policies}};d=function(o,p){return{did:o.did,tn:o.tname,qos:p.policies}};c=d;n=function(p,o){return{h:l(a.CommandId.Create,a.EntityKind.Topic,p),b:h(o)}};j=function(p,o,q){return{h:l(a.CommandId.Create,a.EntityKind.DataReader,p),b:d(o,q)}};m=function(p,o,q){return{h:l(a.CommandId.Create,a.EntityKind.DataWriter,p),b:c(o,q)}};i={};i.log=function(p){var o;o=a.WriteLog(a.EntityKind.Worker,p);return k.postMessage(o)};e=(function(){function o(){this.connected=false;this.closed=false;this.socket=g.None;this.ctrlSock=g.None;this.server="";this.authToken="";this.sn=0;this.drmap={};this.dwmap={};this.tmap={}}o.prototype.connect=function(q,r){var t,s,p;if(this.connected===false){this.server=q;this.authToken=r;t=a.controllerURL(this.server)+"/"+this.authToken;i.log("Connecting to: "+t);this.ctrlSock=g.None;p=new WebSocket(t);s=g.Some(p);s.map(((function(u){return function(v){return v.onopen=function(){var w;i.log("Connected to: "+u.server);u.ctrlSock=s;u.connected=true;w=a.OnConnectedRuntime(u.server);return postMessage(w)}}})(this)));s.map(((function(u){return function(v){return v.onclose=function(w){i.log("The  "+u.server+" seems to have dropped the connection.");u.connected=false;u.closed=true;u.ctrlSock=g.None;return postMessage(a.OnDisconnectedRuntime(u.server))}}})(this)));return s.map(((function(u){return function(v){return v.onmessage=function(w){return u.handleMessage(w)}}})(this)))}else{return i.log("Warning: Trying to connect an already connected Runtime")}};o.prototype.close=function(){if(!this.closed){this.closed=true;return this.disconnect()}};o.prototype.disconnect=function(){if(this.connected){this.connected=false;this.ctrlSock.map(function(p){return p.close()});return this.crtSock=g._None}};o.prototype.createTopic=function(r,s,p){var t,q;i.log("[Log]: Creating Topic for eid = "+p);t=n(this.sn,r);this.tmap[this.sn]=p;this.sn=this.sn+1;q=JSON.stringify(t);return this.ctrlSock.map(function(u){return u.send(q)})};o.prototype.createDataReader=function(r,s,p){var t,q;t=j(this.sn,r,s);this.drmap[this.sn]=p;this.sn=this.sn+1;q=JSON.stringify(t);return this.ctrlSock.map(function(u){return u.send(q)})};o.prototype.createDataWriter=function(r,s,p){var t,q;t=m(this.sn,r,s);this.dwmap[this.sn]=p;this.sn=this.sn+1;q=JSON.stringify(t);return this.ctrlSock.map(function(u){return u.send(q)})};o.prototype.handleMessage=function(t){var p,r,u,q;i.log("CtrlWorker Received messasge from server:"+t.data);u=JSON.parse(t.data);switch(false){case !g.match(u.h,{cid:a.CommandId.OK,ek:a.EntityKind.DataReader}):r=u.b.eid;q=a.readerPrefixURL(this.server)+"/"+r;i.log("sn = "+u.h.sn+", eid = "+this.drmap[u.h.sn]);p=a.OnCreatedDataReader(q,this.drmap[u.h.sn]);delete this.drmap[u.h.sn];return postMessage(p);case !g.match(u.h,{cid:a.CommandId.OK,ek:a.EntityKind.DataWriter}):r=u.b.eid;q=a.writerPrefixURL(this.server)+"/"+r;i.log("sn = "+u.h.sn+", eid = "+this.dwmap[u.h.sn]);p=a.OnCreatedDataWriter(q,this.dwmap[u.h.sn]);delete this.dwmap[u.h.sn];return postMessage(p);case !g.match(u.h,{cid:a.CommandId.OK,ek:a.EntityKind.Topic}):i.log("Topic sn = "+u.h.sn+"  eid = "+this.tmap[u.h.sn]);p=a.OnCreatedTopic(this.tmap[u.h.sn]);delete this.tmap[u.h.sn];return postMessage(p);case !g.match(u.h,{cid:a.CommandId.Error,ek:void 0}):p=OnError(u.h.ek,u.b.msg);return postMessage(p);default:return i.log("ControlLink received invalid message from server")}};return o})();b=new e();k.onmessage=function(o){var p;p=o.data;i.log("CtrlWorker received cmd: "+JSON.stringify(p));switch(false){case !g.match(p.h,a.ConnectCmd):i.log("[control-link]: cmd = Connect ("+p.url+")");return b.connect(p.url,p.authToken);case !g.match(p.h,a.CreateTopicCmd):return b.createTopic(p.topic,p.qos,p.eid);case !g.match(p.h,a.CreateDataReaderCmd):i.log("CreateDataReader: "+p.eid);return b.createDataReader(p.topic,p.qos,p.eid);case !g.match(p.h,a.CreateDataWriterCmd):i.log("CreateDataWriter: "+p.eid);return b.createDataWriter(p.topic,p.qos,p.eid);case !g.match(p.h,a.Disconnect):return b.disconnect();default:return i.log("Worker Received Unknown Command!")}}}).call(this);